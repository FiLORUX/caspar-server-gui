<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,height=device-height,initial-scale=1" />
  <title>TSG Key+Fill Slate</title>
  <style>
    :root{
      --pad: 3.2vmin;
      --radius: 2.2vmin;
      --line: rgba(255,255,255,0.16);
      --line2: rgba(255,255,255,0.09);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.60);
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.10);
      --bg0: rgba(0,0,0,0.00);
      --bg1: rgba(0,0,0,0.18);
      --bg2: rgba(0,0,0,0.32);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --ui: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }

    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: transparent; /* essential for CasparCG key+fill */
      overflow: hidden;
    }

    /* Full stage */
    .stage{
      position: relative;
      width: 100vw;
      height: 100vh;
      background: var(--bg0);
      font-family: var(--ui);
    }

    /* Fill-only texture (subtle structure) – disabled in key mode */
    .stage.fill .texture{
      position:absolute; inset:0;
      background:
        radial-gradient(120vmax 90vmax at 60% 40%, rgba(255,255,255,0.06), transparent 55%),
        linear-gradient(180deg, rgba(0,0,0,0.00), rgba(0,0,0,0.18)),
        repeating-linear-gradient(135deg, rgba(255,255,255,0.035) 0 2px, rgba(0,0,0,0) 2px 10px);
      pointer-events:none;
    }
    .stage.key .texture{ display:none; }

    /* Safe markers (fill only) */
    .safe { position:absolute; inset:0; pointer-events:none; }
    .stage.key .safe{ display:none; }

    .safe .frame{
      position:absolute; inset: var(--pad);
      border: 1px solid var(--line);
      border-radius: var(--radius);
    }
    .safe .title{
      position:absolute;
      inset: calc(var(--pad) * 1.75);
      border: 1px dashed var(--line2);
      border-radius: calc(var(--radius) * 0.85);
    }
    .safe .cross{
      position:absolute; left:50%; top:50%;
      width: 40vmin; height: 40vmin;
      transform: translate(-50%,-50%);
      opacity: 0.35;
    }
    .safe .cross:before,
    .safe .cross:after{
      content:"";
      position:absolute; left:50%; top:50%;
      background: var(--line);
      transform: translate(-50%,-50%);
      border-radius: 999px;
    }
    .safe .cross:before{ width: 40vmin; height: 2px; }
    .safe .cross:after{ width: 2px; height: 40vmin; }

    /* Header bar (separates "FILL" vs "KEY" labels) */
    .hdr{
      position:absolute;
      left: var(--pad);
      right: var(--pad);
      top: var(--pad);
      height: 10vmin;
      min-height: 58px;
      display:flex;
      gap: 2vmin;
      align-items: stretch;
    }
    .box{
      flex: 1;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: linear-gradient(180deg, var(--bg1), var(--bg2));
      display:flex;
      align-items:center;
      padding: 0 2.2vmin;
    }

    /* In key mode we want a clean matte: no thin lines that may cause artefacts */
    .stage.key .box{
      border: none;
      background: rgba(255,255,255,1);
      border-radius: calc(var(--radius) * 0.75);
    }

    .leftLabel, .rightLabel{
      font-family: var(--mono);
      letter-spacing: 0.04em;
      font-size: clamp(14px, 2.15vmin, 22px);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Fill mode: left shows FILL text, right hidden */
    .stage.fill .leftLabel{ color: var(--text); }
    .stage.fill .rightLabel{ display:none; }

    /* Key mode: right shows KEY text as matte (alpha), left is a solid placeholder
       to prevent fill text from being clipped by the key mask. */
    .stage.key .leftLabel{ display:none; }
    .stage.key .rightLabel{
      display:block;
      color: rgba(0,0,0,0); /* RGB oviktigt, vi formar alpha via textens opacity nedan */
      position: relative;
    }
    .stage.key .rightLabel::before{
      content: attr(data-text);
      color: rgba(255,255,255,1);
      /* matte-text: vit = 100% alpha */
    }

    /* Main ID + motion-bar */
    .main{
      position:absolute;
      left: var(--pad);
      right: var(--pad);
      top: calc(var(--pad) + 12vmin);
      bottom: calc(var(--pad) + 16vmin);
      display:grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 3vmin;
      align-items: stretch;
    }

    .panel{
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(0,0,0,0.22), rgba(0,0,0,0.40));
      position: relative;
      overflow:hidden;
    }
    .stage.key .panel{
      border: none;
      background: rgba(255,255,255,1);
      border-radius: calc(var(--radius) * 0.75);
    }

    .idWrap{
      position:absolute; inset:0;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      gap: 1.6vmin;
      padding: 4vmin;
    }

    .idNum{
      font-family: var(--mono);
      font-weight: 700;
      font-size: clamp(92px, 22vmin, 260px);
      line-height: 0.9;
      letter-spacing: -0.03em;
      color: rgba(255,255,255,0.92);
      text-shadow: 0 0 30px rgba(0,0,0,0.45);
    }
    .idMeta{
      font-family: var(--mono);
      font-size: clamp(12px, 1.9vmin, 20px);
      color: var(--muted);
      opacity: 0.95;
    }
    .stage.key .idNum, .stage.key .idMeta{
      color: rgba(255,255,255,1);
      text-shadow: none;
    }

    /* Motion bar */
    .barWrap{
      position:absolute; left: 3.2vmin; right: 3.2vmin; bottom: 4.0vmin;
      height: 6.8vmin;
      min-height: 46px;
      border-radius: calc(var(--radius) * 0.9);
      border: 1px solid var(--line2);
      background: rgba(255,255,255,0.06);
      overflow:hidden;
    }
    .stage.key .barWrap{
      border: none;
      background: rgba(255,255,255,1);
    }

    .barTrack{
      position:absolute; inset:0;
      background:
        linear-gradient(90deg, rgba(255,255,255,0.00), rgba(255,255,255,0.07), rgba(255,255,255,0.00));
      opacity: 0.9;
    }
    .stage.key .barTrack{ display:none; }

    .bar{
      position:absolute;
      top: 12%;
      bottom: 12%;
      width: 18%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(255,255,255,0.16), rgba(255,255,255,0.86), rgba(255,255,255,0.18));
      box-shadow: 0 0 18px rgba(255,255,255,0.22);
      transform: translateX(0);
      will-change: transform;
    }
    .stage.key .bar{
      background: rgba(255,255,255,1);
      box-shadow: none;
    }

    /* Bars panel (test colours) – fill gets colour, key gets matte blocks only */
    .bars{
      display:grid;
      grid-template-rows: 1fr auto;
    }
    .barsTop{
      position:relative;
      padding: 3.2vmin;
      display:flex;
      flex-direction:column;
      gap: 2.2vmin;
    }

    .chipRow{
      display:flex;
      gap: 1.2vmin;
      flex-wrap:wrap;
    }
    .chip{
      width: 7.2vmin;
      min-width: 44px;
      height: 5.1vmin;
      min-height: 32px;
      border-radius: 1.2vmin;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.10);
    }
    .stage.key .chip{
      border:none;
      background: rgba(255,255,255,1);
    }

    .ramp{
      height: 5.4vmin;
      min-height: 34px;
      border-radius: 1.2vmin;
      border: 1px solid rgba(255,255,255,0.12);
      background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.92));
    }
    .stage.key .ramp{
      border:none;
      background: linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,1));
    }

    .barsBottom{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      height: 10.6vmin;
      min-height: 74px;
      border-top: 1px solid var(--line2);
      overflow:hidden;
      border-radius: 0 0 var(--radius) var(--radius);
    }
    .stage.key .barsBottom{
      border-top: none;
      border-radius: 0 0 calc(var(--radius) * 0.75) calc(var(--radius) * 0.75);
    }

    .barC{
      height: 100%;
    }

    /* Fill colours */
    .stage.fill .c1{ background: rgb(191,191,191); }
    .stage.fill .c2{ background: rgb(191,191,0); }
    .stage.fill .c3{ background: rgb(0,191,191); }
    .stage.fill .c4{ background: rgb(0,191,0); }
    .stage.fill .c5{ background: rgb(191,0,191); }
    .stage.fill .c6{ background: rgb(191,0,0); }
    .stage.fill .c7{ background: rgb(0,0,191); }

    /* Key mode: matte blocks only (visual indicator you're viewing KEY output) */
    .stage.key .barC{ background: rgba(255,255,255,1); }

    /* Footer readout */
    .ftr{
      position:absolute;
      left: var(--pad);
      right: var(--pad);
      bottom: var(--pad);
      height: 12vmin;
      min-height: 66px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 2vmin;
      font-family: var(--mono);
      color: var(--muted);
      font-size: clamp(12px, 1.8vmin, 18px);
      opacity: 0.95;
    }
    .stage.key .ftr{
      display:none; /* keep key matte clean */
    }

    .pill{
      padding: 0.9vmin 1.6vmin;
      border: 1px solid var(--line2);
      border-radius: 999px;
      background: rgba(255,255,255,0.06);
    }
  </style>
</head>

<body>
  <div id="stage" class="stage fill">
    <div class="texture"></div>

    <div class="safe">
      <div class="frame"></div>
      <div class="title"></div>
      <div class="cross"></div>
    </div>

    <div class="hdr">
      <div class="box" id="leftBox">
        <div class="leftLabel" id="fillLabel">Channel ? FILL</div>
      </div>
      <div class="box" id="rightBox">
        <div class="rightLabel" id="keyLabel" data-text="Channel ? KEY"></div>
      </div>
    </div>

    <div class="main">
      <div class="panel">
        <div class="idWrap">
          <div class="idNum" id="idNum">?</div>
          <div class="idMeta" id="idMeta">TSG • Key+Fill Slate • HTML</div>
        </div>

        <div class="barWrap">
          <div class="barTrack"></div>
          <div class="bar" id="bar"></div>
        </div>
      </div>

      <div class="panel bars">
        <div class="barsTop">
          <div class="chipRow" id="chipRow">
            <div class="chip" style="background:rgba(255,0,0,0.85)"></div>
            <div class="chip" style="background:rgba(0,255,0,0.85)"></div>
            <div class="chip" style="background:rgba(0,128,255,0.85)"></div>
            <div class="chip" style="background:rgba(255,255,255,0.85)"></div>
            <div class="chip" style="background:rgba(0,0,0,0.85)"></div>
            <div class="chip" style="background:rgba(255,255,0,0.85)"></div>
          </div>
          <div class="ramp"></div>
        </div>

        <div class="barsBottom">
          <div class="barC c1"></div>
          <div class="barC c2"></div>
          <div class="barC c3"></div>
          <div class="barC c4"></div>
          <div class="barC c5"></div>
          <div class="barC c6"></div>
          <div class="barC c7"></div>
        </div>
      </div>
    </div>

    <div class="ftr">
      <div class="pill" id="readoutLeft">ch=? • mode=fill</div>
      <div class="pill" id="readoutRight">t=0.000s</div>
    </div>
  </div>

  <script>
    (function(){
      function parseQuery(){
        var s = window.location.search || "";
        s = s.replace(/^\?/, "");
        var parts = s.split("&").filter(function(p){ return p.length > 0; });
        var out = {};
        for (var i=0;i<parts.length;i++){
          var p = parts[i];
          var eq = p.indexOf("=");
          if (eq === -1){
            if (/^\d+$/.test(p)) out._id = p;
            else out[p] = true;
          } else {
            var k = decodeURIComponent(p.slice(0,eq));
            var v = decodeURIComponent(p.slice(eq+1));
            out[k] = v;
          }
        }
        return out;
      }

      var q = parseQuery();
      var ch = (q.ch || q.channel || q._id || "1").toString();
      if (!/^\d+$/.test(ch)) ch = "1";

      var mode = (q.mode || "fill").toString().toLowerCase();
      if (mode !== "fill" && mode !== "key") mode = "fill";

      var stage = document.getElementById("stage");
      stage.classList.remove("fill","key");
      stage.classList.add(mode);

      // Update labels
      document.getElementById("idNum").textContent = ch;
      document.getElementById("fillLabel").textContent = "Channel " + ch + " FILL";
      document.getElementById("keyLabel").setAttribute("data-text", "Channel " + ch + " KEY");

      // Fill mode: colour chips visible. Key mode: force chips to white matte.
      if (mode === "key"){
        var chips = document.querySelectorAll(".chip");
        for (var i=0;i<chips.length;i++){
          chips[i].style.background = "rgba(255,255,255,1)";
          chips[i].style.border = "none";
        }
      }

      // Readout
      var roL = document.getElementById("readoutLeft");
      var roR = document.getElementById("readoutRight");
      if (roL) roL.textContent = "ch=" + ch + " • mode=" + mode;

      // Motion bar
      var bar = document.getElementById("bar");
      var t0 = (typeof performance !== "undefined" && performance.now) ? performance.now() : Date.now();

      function tick(){
        var now = (typeof performance !== "undefined" && performance.now) ? performance.now() : Date.now();
        var t = (now - t0) / 1000;

        // ping-pong 0..1..0
        var speed = 0.22;
        var ph = (t * speed) % 2;
        var u = (ph <= 1) ? ph : (2 - ph);

        // bar position within wrap: 0..82% (bar width 18%)
        var x = (u * 82);
        if (bar) bar.style.transform = "translateX(" + x + "%)";

        if (roR) roR.textContent = "t=" + t.toFixed(3) + "s";

        requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);

      // CasparCG template hooks (for CG ADD/PLAY with subsequent CG UPDATE)
      window.update = function(raw){
        try {
          // Accepts: {"ch":2,"mode":"fill"} or "2" or "mode=key&ch=3"
          if (typeof raw !== "string") raw = String(raw || "");
          raw = raw.trim();

          var next = { ch: ch, mode: mode };

          if (raw[0] === "{"){
            var o = JSON.parse(raw);
            if (o.ch != null) next.ch = String(o.ch);
            if (o.mode != null) next.mode = String(o.mode);
          } else if (/^\d+$/.test(raw)){
            next.ch = raw;
          } else {
            // simple querystring
            var tmp = raw.replace(/^\?/, "").split("&");
            for (var i=0;i<tmp.length;i++){
              var kv = tmp[i].split("=");
              if (kv.length === 2){
                if (kv[0] === "ch") next.ch = kv[1];
                if (kv[0] === "mode") next.mode = kv[1];
              }
            }
          }

          if (/^\d+$/.test(next.ch)) {
            ch = next.ch;
            document.getElementById("idNum").textContent = ch;
            document.getElementById("fillLabel").textContent = "Channel " + ch + " FILL";
            document.getElementById("keyLabel").setAttribute("data-text", "Channel " + ch + " KEY");
            if (roL) roL.textContent = "ch=" + ch + " • mode=" + mode;
          }

          next.mode = (next.mode || "").toLowerCase();
          if (next.mode === "fill" || next.mode === "key"){
            mode = next.mode;
            stage.classList.remove("fill","key");
            stage.classList.add(mode);
            if (roL) roL.textContent = "ch=" + ch + " • mode=" + mode;
          }
        } catch(e){}
      };

      window.play = function(){ /* optional */ };
      window.stop = function(){ /* optional */ };

    })();
  </script>
</body>
</html>
